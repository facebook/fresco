# Copyright (c) Facebook, Inc. and its affiliates.

#
# GENERAL CONFIG
#
version: 2.1
orbs:
  android: circleci/android@2.5.0

commands:
  run-tests:
    steps:
      - run:
          name: Run Tests
          command: ./gradlew test assembleDebug -PdisablePreDex
  run-instrumentation-tests:
    steps:
      - run:
          name: Run Instrumentation Tests
          command: |
            ./gradlew :samples:showcase:connectedInternalInstrumentationAndroidTest -PdisablePreDex
  copy-results:
    steps:
      - run:
          name: Copy Results
          command: |
            mkdir -p /home/circleci/test-results/junit
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} /home/circleci/test-results/junit \;
  setup-jdk-17:
    steps:
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update && sudo apt-get install openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            java -version
            export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64/"

jobs:
  build:
    environment:
      TERM: 'dumb'
    executor:
      name: android/android-machine
      tag: 2021.10.1
      resource-class: large
    steps:
      - checkout
      - setup-jdk-17
      - android/accept-licenses
      - android/restore-gradle-cache:
          cache-prefix: v1a
      - android/create-avd:
          avd-name: testAVD
          install: true
          system-image: system-images;android-29;default;x86
      - android/start-emulator:
          avd-name: testAVD
          no-window: true
          restore-gradle-cache-prefix: v1a
      - android/wait-for-emulator
      - run-tests
      - android/save-gradle-cache:
          cache-prefix: v1a
      - copy-results
      - store_test_results:
          path: /home/circleci/test-results

workflows:
  build:
    jobs:
      - build
